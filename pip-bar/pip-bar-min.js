// Mali's <pip-bar> custom element

((onPage=0)=>{const format=document.querySelector("tw-storydata").getAttribute("format"),varParser={SugarCube:t=>t.replace(/(?<!\w)\$(?=\w)/g,"State.variables.").replace(/(?<!\w)_(?=\w)/g,"State.temporary."),Harlowe:t=>t.replace(/(?<!\w)\$(?=\w)/g,"State.variables."),Chapbook(t){const e=engine.state.get();for(const s in e)t=t.replace(new RegExp(`\\b${s}\\b`,"g"),e[s]);return t}},config={default:{max:5,value:0}},numGetter=v=>{let num=Number(v);if(isNaN(num))try{num=eval(v)}catch{num=0}return"number"!=typeof num&&(num=0),num};function numSetter(t){return"number"==typeof t&&(t=""+t),isNaN(Number(t))&&!this.hasVariable&&(this.hasVariable=!0,onPage++),varParser[format]&&(t=varParser[format](t)),t}window.PipBar=class extends HTMLElement{constructor(){super(),this.preset="default",this.max=config.default.max,this.value=config.default.value,this.setAttribute("aria-live","polite")}get preset(){return this._preset}set preset(t){if("object"==typeof t)return"string"==typeof t.full&&(t.full={token:t.full}),"string"==typeof t.empty&&(t.empty={token:t.empty}),this._preset=t;if("string"==typeof t){if(PipBar.presets[t])return this.preset=PipBar.presets[t];const[e="",s=""]=t.split(",");this._preset={full:{token:e},empty:{token:s}}}}get value(){return Math.min(numGetter(this._value),this.max)}set value(t){this._value=numSetter.call(this,t)}get max(){return numGetter(this._max)}set max(t){this._max=numSetter.call(this,t)}connectedCallback(){this.firstInit||(this.baseText=this.innerHTML,this.firstInit=!0),this.printValue()}buildBar(t,e){const s=this.preset[e],a=s.token,r=PipBar.classes[e]+(s?.class??""),i="".padEnd(t*a.length,a);return`<span class='${r}' style='${s?.style??""}'>${i}</span>`}printValue(t){const e=this.value,s=this.max,a=e+" out of "+s;(t||a!==this.excerpt)&&(this.innerHTML=this.baseText+`<span class='${PipBar.classes.main}'>`+this.buildBar(e,"full")+this.buildBar(s-e,"empty")+"</span>",this.setAttribute("aria-label",this.excerpt=a))}attributeChangedCallback(t,e,s){if(null!=s){if(t.includes("-")){const[e,a]=t.split("-");this.preset[e][a]=s}switch(t){case"preset":this.preset=s;break;case"tokens":const[e="",a=""]=s.split(",");this.preset.full.token=e,this.preset.empty.token=a;break;case"value":case"max":this[t]=s}this.isConnected&&this.printValue(!0)}}static observedAttributes=["max","value","preset","full-token","empty-token","full-class","empty-class","full-style","empty-style","tokens"];static updateAll=()=>{const t=document.querySelectorAll("pip-bar");t.length||(onPage=0),onPage&&t.forEach((t=>{setTimeout((()=>{t.hasVariable&&t.printValue()}),20)}))};static classes={full:"full-bar",empty:"empty-bar",main:"pip-bar"};static presets={default:"◼,◻",round:"◉,◎",hexa:"⬢,⬡",hexalong:"⬣,⎔",penta:"⬟,⬠",pentalong:"⭓,⭔",diamond:"◈,◇",bar:"𝅛,𝅚",xcom:"▰,▱",sonata:"☐,☒",stars:"★,☆",stars4:"⯌,⯎",ascii:{full:"l",empty:{token:"l",style:"opacity: .5;"}},hearts:{full:"♡",empty:{token:"♡",style:"opacity: .5;"}}};static addPreset(t,e){if(this.presets[e])return this.presets[t]=this.presets[e];if("string"==typeof e&&!e.includes(","))throw new Error("Preset string must contains 2 comma-separated tokens!");if("object"==typeof e&&!e.hasOwnProperty("full")&&!e.hasOwnProperty("empty"))throw new Error('Preset object must have an "empty" and "full" property!');this.presets[t]=e}},customElements.define("pip-bar",PipBar),window.addEventListener("click",PipBar.updateAll,!0),window.addEventListener("keypress",(t=>{"Enter"===t.key&&PipBar.updateAll()}),!0)})();