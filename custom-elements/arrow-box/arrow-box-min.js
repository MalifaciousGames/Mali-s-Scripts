/* Mali's arrow-box custom element */

(()=>{window.ArrowBox=class extends HTMLElement{static config={symbols:{prev:"<",next:">"}};constructor(){super();const e=document.createElement("button");e.innerHTML=this.constructor.config.symbols.prev,e.setAttribute("tabindex",-1),e.addEventListener("click",(()=>{this.select(this.valueIndex-1)}));const t=document.createElement("button");t.innerHTML=this.constructor.config.symbols.next,t.setAttribute("tabindex",-1),t.addEventListener("click",(()=>{this.select(this.valueIndex+1)}));const n=document.createElement("span");this.innerField=n,this.addEventListener("keyup",(e=>{switch(e.key){case"ArrowLeft":case"ArrowUp":return this.select(this.valueIndex-1);case"ArrowRight":case"ArrowDown":return this.select(this.valueIndex+1)}})),this.addEventListener("wheel",(e=>{this.select(this.valueIndex+(e.deltaY<0?1:-1)),e.preventDefault()})),this.valueIndex=0,requestAnimationFrame((()=>{this.append(e,n,t),this.setAttribute("tabindex",0);const i=this.options;if(i.length){const e=i.sort(((e,t)=>t.textContent.length-e.textContent.length))[0];this.innerField.style["min-width"]=e.textContent.length+"ch"}if(this.value)return this.innerField.innerHTML=this.value;let s=i.findIndex((e=>e.selected));-1===s&&(s=0),this.select(s)}))}get options(){const e=[...this.children];if(this.fromList){const t=document.getElementById(this.fromList);t&&e.push(...t.children)}return e.filter((e=>"OPTION"===e.tagName&&!e.disabled))}get selected(){return this.options[this.valueIndex]}select(e=this.valueIndex){const t=this.options;if(!t.length)return;for(;e<0;)e+=t.length;e%=t.length;const n=this.options[e];if(!n)throw new Error("No option at index "+e);this.valueIndex=e,this.setValue(n.value??n.textContent),this.innerField.innerHTML=n.textContent||n.value}setValue(e,t=!0){if(e=this.enforceType(e),this.value=e,!t)return;const n=new CustomEvent("change",{detail:{value:this.value,index:this.valueIndex}});this.dispatchEvent(n)}makeEditable(){this.editable=!0,this.innerField.setAttribute("tabindex",0),this.innerField.setAttribute("contenteditable",!0),this.innerField.setAttribute("spellcheck",!1),this.innerField.addEventListener("keydown",(e=>"Enter"===e.key||"Escape"===e.key?(this.focus(),this.setValue(this.innerField.textContent),!1):"number"!==this.type||1!==e.key.length||/[0-9\._]/.test(e.key)?void 0:(e.preventDefault(),!1)),!0),this.innerField.addEventListener("focusout",(()=>this.setValue(this.innerField.textContent))),this.innerField.addEventListener("keyup",(e=>{e.stopImmediatePropagation();const t=this.selected,n=e.target.textContent;t?t.value=t.innerHTML=n:this.setValue(n,!1),this.innerField.style["min-width"]=n.length+"ch"}))}enforceType(value){if(!this.type||"string"===this.type)return value;try{switch(this.type){case"number":return Number(value);case"json":return JSON.parse(value);case"eval":return eval(value)}}catch(e){return null}}static observedAttributes=["value","type","editable","list"];attributeChangedCallback(e,t,n){switch(e){case"value":const e=this.options.findIndex((e=>e.value===n||e.textContent===n));return-1!==e?this.select(e):this.setValue(n);case"editable":return null!==n&&this.makeEditable();case"type":return this.type=n?.toLowerCase();case"list":this.fromList=n}}},customElements.define("arrow-box",window.ArrowBox)})();